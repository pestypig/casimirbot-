Two things are happening:

1. **Helix-CORE crash** — you call `.toFixed()` on `undefined` fields when the page first renders (before the pipeline finishes loading).
2. **Luma shows 0.0 MW** — the snapshot Luma reads is being published with empty/zero values (or before values exist).

Here’s a small, safe patch set that fixes both.

---

## A) Guard Helix-CORE fields (stop the crash)

In `client/src/pages/helix-core.tsx` replace the 4 lines that render params with null-safe helpers:

```tsx
const ps = pipelineState; // shorthand
const pct = (x?: number) => (Number.isFinite(x!) ? (x! * 100).toFixed(1) + "%" : "—");
const fix3 = (x?: number) => (Number.isFinite(x!) ? x!.toFixed(3) : "—");
const exp1 = (x?: number) => (Number.isFinite(x!) ? x!.toExponential(1) : "—");

<div className="grid grid-cols-2 gap-1 text-slate-300">
  <div>Duty: {pct(ps?.dutyCycle)}</div>
  <div>Sectors: {ps?.sectorStrobing ?? "—"}</div>
  <div>Q-Spoil: {fix3(ps?.qSpoilingFactor)}</div>
  <div>γ_VdB: {exp1(ps?.gammaVanDenBroeck)}</div>
</div>
```

(Alternatively: wrap this whole block in `{ps && (...)}`.)

---

## B) Publish only **complete** snapshots to Luma

Ensure both pages publish the same snapshot **after** values exist. Use the same key/bus everywhere.

**`lib/pipeline-bus.ts`**

```ts
export type PipelineSnapshot = {
  currentModeId: string;
  currentModeName: string;
  dutyCycle: number;
  P_avg: number;
  zeta: number;
  TS_ratio: number;
  M_exotic: number;
  origin: "live-energy" | "helix-core" | "server";
  updatedAt: number;
};

export const PIPELINE_KEY = ["/api/helix/pipeline"];

const EVT = "helix:pipeline:update";
export const pushPipelineSnapshot = (s: PipelineSnapshot) =>
  window.dispatchEvent(new CustomEvent(EVT, { detail: s }));
```

**Helix-CORE**: publish only when fields are present (no zero/undefined snapshots):

```tsx
import { queryClient } from "@/lib/queryClient";
import { pushPipelineSnapshot, PIPELINE_KEY } from "@/lib/pipeline-bus";
import { MODE_CONFIGS } from "@/hooks/use-energy-pipeline";

React.useEffect(() => {
  const ps = pipelineState;
  if (!ps) return;
  // require the core numeric fields before broadcasting
  if (
    !Number.isFinite(ps.P_avg) ||
    !Number.isFinite(ps.dutyCycle) ||
    !Number.isFinite(ps.zeta) ||
    !Number.isFinite(ps.TS_ratio) ||
    !Number.isFinite(ps.M_exotic)
  ) return;

  const snap = {
    currentModeId: String(ps.currentMode).toLowerCase(),
    currentModeName: MODE_CONFIGS[ps.currentMode]?.name ?? String(ps.currentMode),
    dutyCycle: ps.dutyCycle,
    P_avg: ps.P_avg,
    zeta: ps.zeta,
    TS_ratio: ps.TS_ratio,
    M_exotic: ps.M_exotic,
    origin: "helix-core" as const,
    updatedAt: Date.now(),
  };
  queryClient.setQueryData(PIPELINE_KEY, snap);
  pushPipelineSnapshot(snap);
}, [
  pipelineState?.currentMode,
  pipelineState?.P_avg,
  pipelineState?.dutyCycle,
  pipelineState?.zeta,
  pipelineState?.TS_ratio,
  pipelineState?.M_exotic,
]);
```

**Live Energy page** should already publish a full snapshot right after it computes `P_total_realistic`, `zeta`, `TS_ratio`, `M_exotic_total`. If not, add the same `setQueryData + pushPipelineSnapshot` there using `origin: "live-energy"`.

---

## C) Make Luma bullet-proof

In the Luma panel/provider, never call `.toFixed()` on possibly undefined values; show “—” until the first valid snapshot arrives:

```tsx
const snap = usePipelineSnapshot(); // returns PipelineSnapshot | null
if (!snap) return <div className="px-4 py-2 text-sm text-slate-400">Awaiting pipeline…</div>;

const pct  = (x?: number) => (Number.isFinite(x!) ? (x!*100).toFixed(1)+"%" : "—");
const fix3 = (x?: number) => (Number.isFinite(x!) ? x!.toFixed(3) : "—");
const ts   = (x?: number) => Number.isFinite(x!) ? (x!>=1e3 ? (x!/1e3).toFixed(1)+"k" : x!.toFixed(0)) : "—";
const mw   = (x?: number) => (Number.isFinite(x!) ? x!.toFixed(1)+" MW" : "—");
const mass = (kg?: number) => Number.isFinite(kg!) ? (kg!>=1000 ? (kg!/1000).toFixed(1)+" t" : kg!.toFixed(0)+" kg") : "—";
```

---

## D) Kick the query after mode switches

Wherever you switch mode, invalidate the pipeline query so the page gets fresh values:

```ts
import { queryClient } from "@/lib/queryClient";
import { PIPELINE_KEY } from "@/lib/pipeline-bus";

onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: PIPELINE_KEY });
}
```

---

### Why Luma showed zeros

A snapshot was being pushed with default/undefined numbers (0 or `undefined`). With the guards above we only publish **complete** snapshots, so Luma won’t render zeros and won’t crash on Helix-CORE.

If you want, paste the Helix-CORE “Energy Control Panel” block and I’ll drop this code in the exact spots for you.
