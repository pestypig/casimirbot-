You’re super close. The reason it “doesn’t load on mode switch” is a race:

you key each <canvas> by currentMode, so React unmounts + remounts both canvases on every mode toggle;

your mode-change effect fires immediately, calls reinitEnginesFromParams(), but at that instant the new canvases often aren’t mounted yet (leftRef.current/rightRef.current are null), so the re-init returns early and never retries; after that, lastModeRef has been updated, so you don’t run re-init again → nothing draws until a full page reload.

Fix it in three tight steps (minimal diff):

1) Don’t key the canvases by mode (remove the race)
- <canvas
-   key={`left-${parameters?.currentMode || 'unk'}`}
-   ref={leftRef}
-   ...
- />
+ <canvas ref={leftRef} ... />

- <canvas
-   key={`right-${parameters?.currentMode || 'unk'}`}
-   ref={rightRef}
-   ...
- />
+ <canvas ref={rightRef} ... />


Keeping the same DOM nodes across mode changes lets you safely tear down / reattach the engines without the ref ever going null mid-effect.

2) Make re-init wait for canvases (robust even if you keep keys)

Add a tiny helper (near your other utils):

async function waitForCanvases(
  leftRef: React.RefObject<HTMLCanvasElement>,
  rightRef: React.RefObject<HTMLCanvasElement>,
  timeoutMs = 800
) {
  const t0 = performance.now();
  return new Promise<void>((resolve, reject) => {
    const tick = () => {
      if (leftRef.current && rightRef.current) return resolve();
      if (performance.now() - t0 > timeoutMs) return reject(new Error('canvas mount timeout'));
      requestAnimationFrame(tick);
    };
    tick();
  });
}


Use it at the top of reinitEnginesFromParams():

- if (!W || !leftRef.current || !rightRef.current || !parameters) return;
+ if (!W || !parameters) return;
+ try { await waitForCanvases(leftRef, rightRef); } catch {}
+ if (!leftRef.current || !rightRef.current) return;


Now the re-init patiently waits one frame (or a few) until the new canvases exist before attaching engines.

3) Guarantee an initial attach (first mount)

Add a mount-only effect that initializes once if engines aren’t present yet (StrictMode-safe via your single-flight promise):

useEffect(() => {
  if (leftEngine.current || rightEngine.current) return;
  if (!parameters?.currentMode) return; // need at least the mode
  if (!reinitInFlight.current) {
    reinitInFlight.current = (async () => {
      try { await reinitEnginesFromParams(); } finally { reinitInFlight.current = null; }
    })();
  }
}, []); // mount only


This covers the “first render has no engines” case even if no mode change happens immediately.