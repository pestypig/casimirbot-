1) Add a tiny batched-push + first-frame barrier (shared snippet)

Add this helper near the top of both files (or extract to a small util if you prefer):

// --- FAST PATH HELPERS (drop-in) --------------------------------------------

const DEBUG = false;
const IS_COARSE =
  typeof window !== 'undefined' &&
  (matchMedia('(pointer:coarse)').matches || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || ''));

// Batches many uniform patches into ONE engine write + ONE forceRedraw per rAF
function makeUniformBatcher(engineRef: React.MutableRefObject<any>) {
  let pending: any = null;
  let scheduled = false;
  return (patch: any, tag = 'batched') => {
    pending = { ...(pending || {}), ...(patch || {}) };
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(() => {
      scheduled = false;
      const e = engineRef.current;
      if (!e || !pending) return;
      const toSend = pending; pending = null;
      try {
        if (e.isLoaded && e.gridProgram) {
          gatedUpdateUniforms(e, toSend, tag);
          e.forceRedraw?.();
        } else if (typeof e.onceReady === 'function') {
          e.onceReady(() => { gatedUpdateUniforms(e, toSend, tag); e.forceRedraw?.(); });
        }
      } catch (err) {
        if (DEBUG) console.error('[batchPush] failed:', err);
      }
    });
  };
}

// Wait until the engine is really ready, then compute camera once and draw once
async function firstCorrectFrame({
  engine, canvas, sharedAxesScene, pane
}: {
  engine: any; canvas: HTMLCanvasElement; sharedAxesScene: [number,number,number]; pane: 'REAL'|'SHOW';
}) {
  // wait for program + buffers
  await new Promise<void>(res => {
    const tick = () => (engine?.gridProgram && (engine?._vboBytes > 0)) ? res() : requestAnimationFrame(tick);
    tick();
  });

  // single deterministic camera for the first frame
  const cz = safeCamZ(compactCameraZ(canvas, sharedAxesScene));
  const packet = paneSanitize(pane, { cameraZ: cz, lockFraming: true, viewAvg: true });

  gatedUpdateUniforms(engine, packet, 'first-correct-frame');
  engine.forceRedraw?.();
}
