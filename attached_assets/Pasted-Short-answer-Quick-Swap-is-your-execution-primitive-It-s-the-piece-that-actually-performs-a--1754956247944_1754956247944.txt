Short answer: **Quick-Swap is your “execution primitive.”** It’s the piece that actually performs a swap from the user’s wallet. When you plug it into the rest of your stack (Budget-Window, FX converter, Job Router, and—later—Coinbase top-ups), it becomes a one-click step inside an end-to-end plan. Here’s how it all snaps together.

---

### How Quick-Swap fits the whole service

1. **Intent → Plan (Job Router)**

* User types a prompt (“Buy \~\$25 of SHIB on Arbitrum from 1000 NGN”).
* FX widget turns local → USD so the router has a clean budget.
* `/api/jobs/route` builds a plan: maybe bridge → approve → **swap** → gas top-up → receipt.
* **Quick-Swap** is the *swap step* the router calls when it’s time to exchange tokens on a chain.

2. **Live readiness (Budget-Window)**

* After the swap fills, your scheduler pushes a snapshot via `/api/engine/stream` (SSE): new balances, buffer % full, next check time.
* The front page updates instantly; user sees **“Ready to Tap”** turn green.

3. **Cross-network orchestration**

* If funds are on the wrong chain, the plan adds a bridge step first (Across/Socket/LI.FI). When it lands on the target chain:
* **Quick-Swap executes** the final swap using your `/api/swap/quote` → `eth_sendTransaction` flow.
* Result: swap is just *one* step in a multi-step route.

4. **Self-custody mode today; Coinbase mode later**

* Today: Quick-Swap lets MetaMask/CB Wallet users buy altcoins directly—no OAuth, no allowlists.
* Later: the same Job Router can choose **Advanced Trade** (CEX) for best price/fees, then withdraw → bridge → **Quick-Swap** if DEX liquidity is better on target chain.

5. **Controls, guardrails, and receipts**

* Before sending the Quick-Swap tx, the router enforces policy: max slippage/fee, daily caps, chain allowlist.
* After execution, log a **human-readable reason** (“RFQ spread 6.1 bps; gas \$0.03; under cap”). That feeds analytics and user receipts.

---

### What Quick-Swap gives you out of the box

* **Quote abstraction:** `/api/swap/quote` proxies to 0x per chain (no CORS hassle, easy fee params later).
* **Wallet-native execution:** user signs via MetaMask/CB Wallet; you never hold keys.
* **Composable step:** can be called by the prompt-to-plan runner or used standalone on `/quick-swap.html`.

---

### To “use the entire service,” wire these four integration points

1. **Make Quick-Swap a job step**

```js
// in your job runner
steps.push({ type:'swap', chainId, sellToken, buyToken, sellAmountWei });
```

On execute:

* Get 0x quote from `/api/swap/quote`
* Ensure allowance (Permit2/approve)
* `eth_sendTransaction({ to, data, value })`
* Emit progress on `/api/jobs/stream/:jobId` and update Budget-Window snapshot

2. **Feed the Budget-Window after each step**

* After bridge or swap completes:

```js
updateSnapshot({ userId, ts: Date.now(), bufferUsd, targetUsd, deficitUsd, nextAction, reason })
```

3. **Use FX quotes to size swaps automatically**

* From the converted USD amount, compute how much **sell token** to send to Quick-Swap on the chosen chain.
* Keep a tiny native-gas reserve (e.g., leave 0.002 ETH on Arbitrum).

4. **Policy & safety**

* Enforce `maxSlippageBps`, `maxFeeUsd`, daily caps before calling Quick-Swap.
* Abort if quote > limits; show a retry or slower/cheaper route.

---

### Suggested near-term upgrades (fast wins)

* **Auto-approve + decimals** in Quick-Swap so ERC-20 sells “just work.”
* **Permit2** to avoid repeated approvals (MetaMask supports).
* **Gas rescue** toggle: if user lacks \$0.25 native gas, sponsor it and claw back from the swap (with consent).
* **Bridge step**: simple Across or Socket quote + tx sender; then hand off to Quick-Swap for the final swap.
* **Receipts**: store `{ chainId, to, dataHash, price, fees, reason }` and show in “View Analytics.”

---

### Example user story end-to-end

> “Buy \~\$50 of SHIB on Arbitrum using whatever I have.”

* Router: checks CEX balances, wallet balances, FX rate; decides **Base ETH → bridge → Arbitrum swap**.
* Bridge step executes (user signs).
* **Quick-Swap** executes the SHIB swap on Arbitrum (user signs).
* Budget-Window: buffer rises; card shows **Ready**.
* Receipt: “Used Base→Arb via Across. RFQ swap spread 5.8 bps. Gas \$0.04. Total \$50.12.”

---

Bottom line: **Quick-Swap is the engine’s “swap gear.”** Keep it minimal and reliable; let the Job Router decide *when* to use it, FX decide *how much*, the Bridge decide *where*, and the Budget-Window show the result in real time. Once Coinbase OAuth/Advanced Trade are approved, the same orchestration flips between CEX and DEX automatically to minimize cost and keep the “Ready-to-Tap” buffer full.
