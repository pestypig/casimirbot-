name: helix-decision-validate

on:
  workflow_dispatch:
    inputs:
      run_decision_grade:
        description: "Set true to run decision-grade package+validate checks"
        required: false
        default: "false"
  # Explicit policy: label-only opt-in runs regardless of changed file paths.
  pull_request:
    types: [opened, reopened, synchronize, labeled]

jobs:
  validate:
    if: >-
      github.event_name == 'workflow_dispatch' && github.event.inputs.run_decision_grade == 'true'
      || github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-decision-grade')
    runs-on: ubuntu-latest
    steps:
      - name: Decision-grade trigger policy
        run: |
          echo "Decision-grade checks run only with explicit opt-in."
          echo "Policy mode: label-only trigger is allowed regardless of path changes."
          echo "PRs require label: run-decision-grade. workflow_dispatch requires input run_decision_grade=true."
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run helix:decision:package
      - run: npm run helix:decision:validate -- --package reports/helix-decision-package.json
