name: Release Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to release"
        required: true
        type: choice
        options:
          - cli
          - sdk
          - both
      version:
        description: "Version bump (patch/minor/major or explicit x.y.z)"
        required: true
        default: "patch"
      publish:
        description: "Publish to npm"
        required: false
        type: boolean
        default: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
          cache: npm

      - name: Configure git
        shell: bash
        run: |
          git config user.name "casimir-release"
          git config user.email "actions@github.com"

      - name: Build + bump SDK
        if: ${{ inputs.package == 'sdk' || inputs.package == 'both' }}
        shell: bash
        run: |
          set -euo pipefail
          cd sdk
          npm install
          npm version "${{ inputs.version }}" --no-git-tag-version
          npm run build
          echo "SDK_VERSION=$(node -p \"require('./package.json').version\")" >> "$GITHUB_ENV"

      - name: Build + bump CLI
        if: ${{ inputs.package == 'cli' || inputs.package == 'both' }}
        shell: bash
        run: |
          set -euo pipefail
          cd cli
          npm install
          npm version "${{ inputs.version }}" --no-git-tag-version
          npm run build
          chmod +x bin/casimir.js bin/casimir-verify.js
          echo "CLI_VERSION=$(node -p \"require('./package.json').version\")" >> "$GITHUB_ENV"

      - name: Commit + tag
        shell: bash
        run: |
          set -euo pipefail
          git add sdk/package.json cli/package.json
          if git diff --cached --quiet; then
            echo "No version changes to commit."
          else
            git commit -m "chore(release): bump packages"
          fi
          if [ -n "${SDK_VERSION:-}" ]; then
            git tag "casimir-sdk-v${SDK_VERSION}"
          fi
          if [ -n "${CLI_VERSION:-}" ]; then
            git tag "casimir-cli-v${CLI_VERSION}"
          fi
          git push origin "HEAD:${{ github.ref_name }}"
          git push origin --tags

      - name: Publish SDK
        if: ${{ inputs.publish && (inputs.package == 'sdk' || inputs.package == 'both') }}
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          cd sdk
          npm publish

      - name: Publish CLI
        if: ${{ inputs.publish && (inputs.package == 'cli' || inputs.package == 'both') }}
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          cd cli
          npm publish
