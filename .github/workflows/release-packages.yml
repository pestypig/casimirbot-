name: Release Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to release"
        required: true
        type: choice
        options:
          - cli
          - sdk
          - both
      version:
        description: "Version bump (patch/minor/major or explicit x.y.z)"
        required: true
        default: "patch"
      publish:
        description: "Publish to npm"
        required: false
        type: boolean
        default: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
          cache: npm

      - name: Configure git
        shell: bash
        run: |
          git config user.name "casimir-release"
          git config user.email "actions@github.com"

      - name: Install root dependencies
        run: npm ci

      - name: Validate agent context checklist
        run: npm run audit:agent-context:check

      - name: Build + bump SDK
        if: ${{ inputs.package == 'sdk' || inputs.package == 'both' }}
        shell: bash
        run: |
          set -euo pipefail
          cd sdk
          npm install
          npm version "${{ inputs.version }}" --no-git-tag-version
          npm run build
          echo "SDK_VERSION=$(node -p \"require('./package.json').version\")" >> "$GITHUB_ENV"

      - name: Build + bump CLI
        if: ${{ inputs.package == 'cli' || inputs.package == 'both' }}
        shell: bash
        run: |
          set -euo pipefail
          cd cli
          npm install
          npm version "${{ inputs.version }}" --no-git-tag-version
          npm run build
          chmod +x bin/shadow-of-intent.js bin/shadow-of-intent-verify.js
          echo "CLI_VERSION=$(node -p \"require('./package.json').version\")" >> "$GITHUB_ENV"

      - name: Casimir verify (release gate)
        env:
          ADAPTER_VERIFY_URL: ${{ secrets.CASIMIR_ADAPTER_VERIFY_URL }}
          TRACE_EXPORT_URL: ${{ secrets.CASIMIR_TRACE_EXPORT_URL }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${ADAPTER_VERIFY_URL:-}" ]; then
            echo "CASIMIR_ADAPTER_VERIFY_URL secret is required for release verification" >&2
            exit 1
          fi
          export_url="${TRACE_EXPORT_URL:-}"
          if [ -z "$export_url" ]; then
            export_url="${ADAPTER_VERIFY_URL%/api/agi/adapter/run}/api/agi/training-trace/export"
          fi
          mkdir -p artifacts
          npm run casimir:verify -- --ci --url "$ADAPTER_VERIFY_URL" --export-url "$export_url" --trace-out artifacts/release-training-trace.jsonl --trace-limit 200 | tee artifacts/release-casimir-verify-response.json
          node -e 'const fs=require("fs"); const adapter=process.env.ADAPTER_VERIFY_URL; const raw=fs.readFileSync("artifacts/release-casimir-verify-response.json","utf8"); const j=JSON.parse(raw); const verdict=(j.verdict ?? (j.pass ? "PASS" : "FAIL")); const cert=j.certificate ?? {}; const integrity=(cert.integrityOk===true?"OK":"NOT_OK"); console.log(`[casimir-release-verify] adapter_url=${adapter} verdict=${verdict} cert_integrity=${integrity}`);'

      - name: Commit + tag
        shell: bash
        run: |
          set -euo pipefail
          git add sdk/package.json cli/package.json
          if git diff --cached --quiet; then
            echo "No version changes to commit."
          else
            git commit -m "chore(release): bump packages"
          fi
          if [ -n "${SDK_VERSION:-}" ]; then
            git tag "shadow-of-intent-sdk-v${SDK_VERSION}"
          fi
          if [ -n "${CLI_VERSION:-}" ]; then
            git tag "shadow-of-intent-v${CLI_VERSION}"
          fi
          git push origin "HEAD:${{ github.ref_name }}"
          git push origin --tags

      - name: Publish SDK
        if: ${{ inputs.publish && (inputs.package == 'sdk' || inputs.package == 'both') }}
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          cd sdk
          npm publish

      - name: Publish CLI
        if: ${{ inputs.publish && (inputs.package == 'cli' || inputs.package == 'both') }}
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          cd cli
          npm publish
