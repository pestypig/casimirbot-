name: Casimir Verify

on:
  pull_request:
  push:
  workflow_dispatch:
    inputs:
      run_decision_grade:
        description: "Also run Helix decision-grade package + validate"
        required: false
        default: "false"
      run_evolution_report_only:
        description: "Run optional report-only evolution gate artifact step"
        required: false
        default: "false"

jobs:
  casimir-verify:
    runs-on: ubuntu-latest
    env:
      PORT: 5173
      ENABLE_AGI: 1
      ENABLE_ESSENCE: 1
      ENABLE_AGI_AUTH: 0
      AGI_TENANT_REQUIRED: 0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Verify ideology verifiers pack
        run: npm run verify:ideology-verifiers

      - name: Validate agent context checklist
        run: npm run audit:agent-context:check

      - name: Validate math stages
        env:
          MATH_UNIT_WARNINGS_STRICT: "1"
        run: npm run math:validate

      - name: Generate CI reports
        run: npm run reports:ci

      - name: Solar pipeline determinism gate
        run: npm run solar:pipeline -- --surface datasets/solar/solar-surface.fixture.json --expect datasets/solar/solar-pipeline.fixture.json

      - name: Start AGI API
        run: |
          npm run dev:agi:5173 > /tmp/agi.log 2>&1 &
          node -e "const url='http://localhost:5173/api/agi/constraint-packs'; const timeoutMs=60000; const start=Date.now(); const delay=ms=>new Promise(r=>setTimeout(r,ms)); (async()=>{ while(true){ try { const res=await fetch(url); if(res.ok){ console.log('AGI API is up'); process.exit(0);} } catch {} if(Date.now()-start>timeoutMs){ console.error('Timed out waiting for AGI API'); process.exit(1);} await delay(1000);} })();"

      - name: Run Casimir verify
        env:
          ADAPTER_VERIFY_URL: http://localhost:5173/api/agi/adapter/run
          TRACE_EXPORT_URL: http://localhost:5173/api/agi/training-trace/export
        run: |
          set -euo pipefail
          mkdir -p artifacts
          npm run casimir:verify -- --params '{"traceId":"ci:casimir","actions":[{"id":"ci-proposal","params":{"dutyEffectiveFR":0.0025}}],"budget":{"maxIterations":1,"maxTotalMs":60000}}' --trace-out artifacts/training-trace.jsonl --trace-limit 200 --ci --url "$ADAPTER_VERIFY_URL" --export-url "$TRACE_EXPORT_URL" | tee artifacts/casimir-verify-response.json
          node -e 'const fs=require("fs"); const adapter=process.env.ADAPTER_VERIFY_URL; const raw=fs.readFileSync("artifacts/casimir-verify-response.json","utf8"); const j=JSON.parse(raw); const verdict=(j.verdict ?? (j.pass ? "PASS" : "FAIL")); const cert=j.certificate ?? {}; const integrity=(cert.integrityOk===true?"OK":"NOT_OK"); console.log(`[casimir-verify] adapter_url=${adapter} verdict=${verdict} cert_integrity=${integrity}`);'


      - name: Evolution report-only gate (optional)
        if: github.event_name == 'workflow_dispatch' && inputs.run_evolution_report_only == 'true'
        run: |
          mkdir -p artifacts
          curl -sS -X POST http://localhost:5173/api/evolution/gate/run \
            -H 'content-type: application/json' \
            -d '{"reportOnly":true,"indicators":{"I":0.9,"A":0.9,"P":0.9,"E":1,"debt":0.1}}' \
            | tee artifacts/evolution-gate-report.json


      - name: Evolution hardening contract checks (optional)
        if: github.event_name == 'workflow_dispatch' && inputs.run_evolution_report_only == 'true'
        run: npx vitest run tests/evolution.gate.spec.ts tests/evolution.training-trace.spec.ts

      - name: Decision-grade checks skipped by default
        if: github.event_name != 'workflow_dispatch' || inputs.run_decision_grade != 'true'
        run: echo "Helix decision-grade packaging/validation is opt-in. Use workflow_dispatch input run_decision_grade=true or run helix-decision-grade workflow."

      - name: Generate helix decision package
        if: github.event_name == 'workflow_dispatch' && inputs.run_decision_grade == 'true'
        run: npm run helix:decision:package

      - name: Validate helix decision package
        if: github.event_name == 'workflow_dispatch' && inputs.run_decision_grade == 'true'
        run: npm run helix:decision:validate -- --package reports/helix-decision-package.json

      - name: Generate math report
        if: always()
        run: |
          npm run math:report
          mkdir -p artifacts
          cp reports/math-report.json artifacts/math-report.json
          cp reports/math-report.md artifacts/math-report.md

      - name: Upload training trace
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-trace
          path: artifacts/training-trace.jsonl
          if-no-files-found: warn

      - name: Upload evolution report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evolution-gate-report
          path: artifacts/evolution-gate-report.json
          if-no-files-found: warn

      - name: Upload math report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: math-report
          path: |
            artifacts/math-report.json
            artifacts/math-report.md
          if-no-files-found: warn
